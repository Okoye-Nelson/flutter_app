version: 2.1
orbs:
  android: circleci/android@0.2.1
  ios: circleci/ios@1.1.0

jobs:
  build_and_deploy_android:
    executor:
      name: android/default
    steps:
      - checkout
      - run: git clone https://github.com/flutter/flutter.git -b stable --depth 1
      - run: export PATH="$PATH:`pwd`/flutter/bin"
      - run: flutter doctor
      - run: flutter pub get
      - run: flutter build apk
      - run: pwd && cd build && ls
      - deploy:
          name: Deploy APK to S3
          command: |
            curl -sL https://raw.githubusercontent.com/jakejarvis/s3-sync-action/master/src/main.js |
              node -- --args="--acl public-read" --source-dir=build/app/outputs/flutter-apk/app-release.apk
              --bucket=app-nelson1234 --region=us-east-1 --destination-dir=/
          requires:
            - build_and_deploy_android

  build_and_deploy_ios:
    executor:
      name: ios/default
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            brew install --HEAD usbmuxd
            brew unlink usbmuxd
            brew link usbmuxd
            brew install ideviceinstaller ios-deploy cocoapods
            git clone -b stable https://github.com/flutter/flutter.git $HOME/flutter
            flutter doctor
      - run:
          name: Build iOS app
          command: flutter build ios --release --no-codesign
      - run:
          name: Deploy iOS app
          command: |
            brew install awscli
            aws s3 sync ~/project/build/ios/iphoneos/ s3://app-nelson1234/ --acl public-read --delete
            rm -rf ~/Library/Developer/Xcode/DerivedData/

workflows:
  build_and_deploy:
    jobs:
      - build_and_deploy_android:
          filters:
            branches:
              only:
                - main
      - build_and_deploy_ios:
          filters:
            branches:
              only:
                - main
